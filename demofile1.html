<!doctype html>
<html>
  <head>
    <title>SnackFox</title>
	<style>

body, html {
  height: 100%;
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  text-align: center;
  padding:0;
  color:#FFFFFF;
	font-weight:300;
	font-family:'Roboto',sans-serif;
	line-height:1.55;
	overflow-x:hidden;
}
div {
  padding: 10px 10px 10px 10px;
}
@font-face {
	font-family: 'Roboto';
	font-style: normal;
	font-weight: 300;
	src: url("Roboto-Light.woff") format('woff');
}
.bttn{
	display:inline-block;
	font-size:1.32em;
  min-width: 100px;
	padding:0.3em 0.75em;
	margin:0.5em 0.8em 0.5em 0;
	border:0.1em solid #FFFFFF;
	border-radius:0.12em;
	transition: all 0.2s;
	text-decoration:none;
	font-weight:400;
  font-size:1.5em;
}
.bttn:hover, .bttn:focus, .bttn:active{
	color:#000000 !important;
	background-color:#FFFFFF !important;
	font-weight:400;
}
.bg {
   background-image: linear-gradient(45deg, #6a3093, #a044ff); 
  height: 100%; 
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
}
#background{
	position:fixed;
	z-index:-1;
	top:0;
	left:0;
	width:100vw;
	height:100vh;
	overflow:hidden;
	background-color:#0f0919;
}
#bkFrame{
  width:100vw;
	height:100vh;
}
@font-face {
    font-family: 'Lato';
    src: url('lato-black.woff') format('woff');
    font-weight: 900;
    font-style: normal;
}
@font-face {
    font-family: 'Lato';
    src: url('lato-bold.woff') format('woff');
    font-weight: 700;
    font-style: normal;
}
h1,h2,h3,h4,h5,h6{
	font-family:'Lato', sans-serif;
	color:#FFFFFF;
	margin:1.7em 0 0.5em 0;
	font-weight:900;
	line-height:1em;
	text-transform:uppercase;
}
.center {
  margin: auto;
  text-align: center;
}

</style>
<meta name="viewport" content="width=device-width, initial-scale=1" /> 
  </head>
  <body>
    <script type="text/javascript" src="/background.js"></script>
    <div id="background">
      <canvas id="bkFrame" width="100px" height="100px">fsfsdfsdfsd</canvas>
      <script type="text/javascript">
        spaceBg=new WarpSpeed("bkFrame",{targetSpeed:0.8,speedWhileLoading:8, speedAdjFactor:0.07, shape:"square", backgroundColor:"hsl(263,45%,8%)", speedWhileLoading:18,density:2.6});
      </script>
    </div>
    
  <div id ="bg">
  <div id="welcomeScreen">
	  <h1>Welcome to SnackFox</h1>
		<p>From the creators of PhotoJoke & Melvin's Graphs</p>
		<ul id="messages"></ul>
		<form class="center" id="myForm">
		  <input id="m" placeholder="Enter Name">
    </form>
    <div id="signin"><p class="bttn" >Play</p></div>
    
	</div>
	<div id="selectRoomScreen" style='display:none;'>
		 <h2>Select a room</h2>
		 <p class="bttn" id="createroom">Create a room</p>
		 <ul id="rooms"></ul>
  </div>
  <div id="lobbyScreen" style='display:none;'>
    <h2 id="lobbyName">lobbyScreen</h2>
    <ul id="lobbyPlayers"></ul>
    <div id="leave"><p class="bttn" >Leave</p></div>
    <div  id="startGame" style='display:none;'><p class="bttn">Start Game</p></div>
 </div>
</div>

	<script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  
<script>
var player = {name: "hello",room: "", isHost:false};
 var socket = io();
 players = {};
var spaceBg;
function joinRoom(room){
        console.log("Joined" +room);
        player.room = unescape(room);
        socket.emit('update player', JSON.stringify(player));
        document.getElementById("lobbyScreen").style.display = "";
        document.getElementById("selectRoomScreen").style.display = "none";
    }

  function kickPlayer(p){
      console.log("Kicked " +p);
      socket.emit('kick player', unescape(p));
  }
  
  $(function () {
    function signin(e){
      e.preventDefault(); // prevents page reloading
      if ($('#m').val().length > 0){
      player.name = $('#m').val();
      document.getElementById("welcomeScreen").style.display = "none";
      document.getElementById("selectRoomScreen").style.display = "";

      socket.emit('request update');
      }
      return false;
    }
    $('#signin').click(signin);
    $('#myForm').submit(signin);
    $('#leave').click(function(e){
      console.log("Leave" + socket.id);
      kickPlayer(socket.id);
    });
    $('#startGame').click(function(e){
      socket.emit("start game",player.room);
    });
    
    function updateRooms(rooms){
      $('#rooms').empty();
      if (Object.keys(rooms).length == 0){
        $('#rooms').append("No rooms found, why not create one!");
      }else{
        for(var room in rooms){
          console.log(room);
          //var text = "<li onClick=joinRoom("hys room")>hys room - 1 players</li>
         var text = "".concat("<li onClick=joinRoom(\"",escape(room),"\")><p>",room," - ",Object.keys(rooms[room]).length," players","</p></li>");
            console.log(text);
          $('#rooms').append(text);
      }
      }
    }
    function updateLobby(rooms){
      console.log("updating lobby " + JSON.stringify(rooms) + " " + player.hasOwnProperty("room"));
      
      if (player.hasOwnProperty("room")){

        if(player.isHost){
          document.getElementById("startGame").style.display = "";
        }else{
          document.getElementById("startGame").style.display = "none"; 
        }

        $('#lobbyName').text(player.room);
        $('#lobbyPlayers').empty();
        if (player.room in rooms){
          for(var p in rooms[player.room]){
            var currentPlayer = rooms[player.room][p];
            var text = "";
            if (currentPlayer.isHost){
              text = "<li><p>" + rooms[player.room][p].name + " [HOST]" + "</p></li>"
            }else{
              if(player.isHost){
                //text = "<li onClick=clickPlayer(\"",escape(currentPlayer),"\")>"+ rooms[player.room][p].name + " click to kick" + "</li>"
                text = "<li onClick=kickPlayer(\"" + escape(p) + "\")><p>" + rooms[player.room][p].name + " [Kick] </p>" + "</li>"
              }else{
                text = "<li>" + rooms[player.room][p].name + "" + "</li>"
              }
            }
            $('#lobbyPlayers').append(text);
        }
        }
    }
    }

	  socket.on('update players', function(p){
      document.getElementById("playersOnline").innerHTML = "Players online: " +  p + "<br><br>" + JSON.stringify(player);
      players = JSON.parse(p);
      updateRooms(players);
      updateLobby(players);
    });

    socket.on('kick player', function(p){
      if(socket.id == JSON.parse(p)){
        player.room = "";
        player.isHost = false;
        document.getElementById("lobbyScreen").style.display = "none";
       document.getElementById("selectRoomScreen").style.display = "";  
      }
    });
    socket.on("start game", function(){
      spaceBg.speedWhileLoading = 18;
      spaceBg.warp(5000);
    });

    $("#createroom").click(function(e){
      var roomName = player.room;
      player.room = player.name + "'s room"
      player.isHost = true;
      socket.emit('update player', JSON.stringify(player));
      document.getElementById("lobbyScreen").style.display = "";
      document.getElementById("selectRoomScreen").style.display = "none";  
    });
  });

</script>
  <p id="playersOnline">test</p>
 </body>
</html>